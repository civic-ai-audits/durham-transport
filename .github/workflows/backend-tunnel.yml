name: Backend API with Public URL

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'Server duration in hours'
        required: true
        default: '6'
        type: choice
        options:
          - '1'
          - '2'
          - '6'
          - '12'

jobs:
  backend-with-tunnel:
    runs-on: ubuntu-latest
    timeout-minutes: 720  # 12 hours max

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt

      - name: Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt
          pip install flask-cors

      - name: Generate data
        run: |
          cd backend
          if [ ! -f "data/raw/durham_census_tracts.geojson" ]; then
            python ../scripts/fetch_durham_data.py
            python ../scripts/simulate_ai_predictions.py
          fi

      - name: Install ngrok
        run: |
          curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc | \
            sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
          echo "deb https://ngrok-agent.s3.amazonaws.com buster main" | \
            sudo tee /etc/apt/sources.list.d/ngrok.list
          sudo apt update && sudo apt install ngrok

      - name: Start Backend API
        run: |
          cd backend
          python app.py &
          sleep 5
          curl -f http://localhost:5000/api/health

      - name: Start ngrok tunnel
        env:
          NGROK_AUTHTOKEN: ${{ secrets.NGROK_AUTHTOKEN }}
        run: |
          if [ -n "$NGROK_AUTHTOKEN" ]; then
            ngrok config add-authtoken $NGROK_AUTHTOKEN
            ngrok http 5000 --log=stdout > ngrok.log &
            sleep 5

            # Get public URL
            NGROK_URL=$(curl -s http://localhost:4040/api/tunnels | jq -r '.tunnels[0].public_url')
            echo "üåê Public API URL: $NGROK_URL"
            echo "üåê API Endpoints:"
            echo "   $NGROK_URL/api/health"
            echo "   $NGROK_URL/api/test1/report"
            echo ""
            echo "NGROK_URL=$NGROK_URL" >> $GITHUB_ENV
          else
            echo "‚ö†Ô∏è  NGROK_AUTHTOKEN not set. Server only available locally."
            echo "   To enable public access, add NGROK_AUTHTOKEN to repository secrets"
            echo "   Get token from: https://dashboard.ngrok.com/get-started/your-authtoken"
          fi

      - name: Keep server alive
        run: |
          DURATION_HOURS=${{ github.event.inputs.duration }}
          DURATION_SECONDS=$((DURATION_HOURS * 3600))
          END_TIME=$(($(date +%s) + DURATION_SECONDS))

          echo "Server will run for $DURATION_HOURS hours"
          echo "Will shutdown at: $(date -d @$END_TIME)"
          echo ""

          while [ $(date +%s) -lt $END_TIME ]; do
            sleep 300  # Check every 5 minutes

            if ! curl -sf http://localhost:5000/api/health > /dev/null; then
              echo "‚ùå Health check failed! Server may have crashed."
              exit 1
            fi

            REMAINING=$((END_TIME - $(date +%s)))
            REMAINING_HOURS=$((REMAINING / 3600))
            REMAINING_MINS=$(((REMAINING % 3600) / 60))

            echo "$(date): ‚úì Server healthy. $REMAINING_HOURS h $REMAINING_MINS m remaining"

            if [ -n "${NGROK_URL:-}" ]; then
              echo "   Public URL: $NGROK_URL"
            fi
          done

          echo "‚úì Planned duration complete. Shutting down gracefully."

      - name: Cleanup
        if: always()
        run: |
          echo "Shutting down services..."
          pkill -f "python app.py" || true
          pkill -f "ngrok" || true
          echo "‚úì Cleanup complete"
