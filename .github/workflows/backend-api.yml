name: Backend API Server

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'start'
        type: choice
        options:
          - start
          - stop
          - restart
  schedule:
    # Keep alive - run every 5 hours to prevent timeout
    - cron: '0 */5 * * *'

jobs:
  backend-server:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 hours max

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt

      - name: Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt

      - name: Generate data (if missing)
        run: |
          cd backend
          if [ ! -f "data/raw/durham_census_tracts.geojson" ]; then
            echo "Generating Durham census data..."
            python ../scripts/fetch_durham_data.py
            python ../scripts/simulate_ai_predictions.py
          else
            echo "Data already exists, skipping generation"
          fi

      - name: Start Backend API
        run: |
          cd backend
          echo "Starting Flask API server..."
          echo "API will be available for the duration of this workflow run"
          python app.py &

          # Wait for server to start
          sleep 5

          # Test health endpoint
          curl -f http://localhost:5000/api/health || exit 1

          echo "✓ Backend API is running"
          echo "✓ Health check passed"
          echo ""
          echo "API Endpoints:"
          echo "  http://localhost:5000/api/health"
          echo "  http://localhost:5000/api/test1/report"
          echo ""
          echo "This server will run for up to 6 hours or until manually stopped"

      - name: Keep server alive
        run: |
          echo "Server is running. Keeping alive..."
          # Keep the job alive - it will timeout after 6 hours
          while true; do
            sleep 300  # Sleep for 5 minutes
            echo "$(date): Server still running..."
            # Health check
            if ! curl -f http://localhost:5000/api/health; then
              echo "Health check failed! Exiting..."
              exit 1
            fi
          done

      - name: Shutdown notification
        if: always()
        run: |
          echo "Backend API server is shutting down"
          echo "Workflow run duration: ${{ job.duration }} seconds"
